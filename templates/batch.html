<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application Automation - Batch Processing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --pending: #3b82f6;
            --bg-light: #f9fafb;
            --border: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
        }
        
        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 2px;
        }
        
        /* Left Column - Input */
        .input-section textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        .input-section textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .url-counter {
            margin: 12px 0;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-primary);
            border: 2px solid var(--border);
            flex: 0 1 auto;
        }
        
        .btn-secondary:hover {
            background: white;
            border-color: var(--primary);
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
            border: 2px solid #f59e0b;
            flex: 0 1 auto;
        }
        
        .btn-warning:hover {
            background: #d97706;
            border-color: #d97706;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Progress Section */
        .progress-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid var(--border);
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        
        .progress-info strong {
            color: var(--text-primary);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-light);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* Queue Table */
        .queue-table-wrapper {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .queue-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        
        .queue-table thead {
            background: var(--bg-light);
            border-bottom: 2px solid var(--border);
        }
        
        .queue-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .queue-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .queue-table tbody tr:hover {
            background: var(--bg-light);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85em;
        }
        
        .status-badge.completed {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }
        
        .status-badge.processing {
            background: rgba(59, 130, 246, 0.1);
            color: var(--pending);
        }
        
        .status-badge.queued {
            background: rgba(107, 114, 128, 0.1);
            color: var(--text-secondary);
        }
        
        .status-badge.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }
        
        .status-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .action-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.85em;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .action-link:hover {
            background: rgba(102, 126, 234, 0.1);
            text-decoration: underline;
        }
        
        .action-link.download::before {
            content: '‚¨á ';
        }
        
        .action-link.trello::before {
            content: 'üîó ';
        }
        
        /* Right Column - Results */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            border-color: var(--primary);
            background: white;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-number.success {
            color: var(--success);
        }
        
        .stat-number.warning {
            color: var(--warning);
        }
        
        .stat-number.error {
            color: var(--error);
        }
        
        .stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .recent-files {
            background: var(--bg-light);
            border-radius: 8px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .recent-files-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        .file-item {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .file-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 500;
            font-size: 0.9em;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-time {
            font-size: 0.8em;
            color: var(--text-secondary);
        }
        
        .file-download {
            color: var(--primary);
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            margin-left: 10px;
            transition: all 0.3s;
        }
        
        .file-download:hover {
            color: var(--primary-dark);
        }
        
        .view-all-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            padding: 10px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .view-all-link:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        /* Settings Section */
        .settings-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .settings-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
        }
        
        .settings-label {
            font-weight: 600;
            font-size: 0.95em;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .settings-group select {
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .settings-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 1.1em;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 640px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .card {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn-primary {
                flex: 1;
            }
            
            .queue-table {
                font-size: 0.8em;
            }
            
            .queue-table th,
            .queue-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Job Application Automation</h1>
            <p>Batch Process ‚Ä¢ Organize ‚Ä¢ Generate ‚Ä¢ Apply</p>
        </div>
        
        <div class="main-grid">
            <!-- Left Column: Input & Queue -->
            <div class="card">
                <div class="card-title">Job URLs</div>
                
                <div class="input-section">
                    <textarea id="urlInput" placeholder="Paste Stepstone job URLs here (one per line)..."></textarea>
                    <div class="url-counter">
                        <span id="urlCount">0</span> URLs entered
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" id="processAllBtn" onclick="processAllJobs()">
                            ‚ñ∂ Process All Jobs
                        </button>
                        <button class="btn btn-warning" id="pauseBtn" onclick="togglePause()" style="display: none;">
                            ‚è∏ Pause
                        </button>
                        <button class="btn btn-secondary" id="clearAllBtn" onclick="clearInput()">Clear All</button>
                        <button class="btn btn-danger" id="cancelAllBtn" onclick="cancelAll()" style="display: none;">
                            ‚úï Cancel All
                        </button>
                    </div>
                </div>
                
                <!-- Progress Section -->
                <div class="progress-section" id="progressSection" style="display: none;">
                    <div class="progress-info">
                        <strong>Job <span id="jobsProcessing">0</span> of <span id="jobsTotal">0</span></strong>
                        <span><span id="progressPercent">0</span>%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progressBar"></div>
                    </div>
                    <div class="progress-step-indicator" id="progressStep" style="margin-top: 8px; font-size: 0.9em; color: var(--text-secondary); font-weight: 500;">
                        Gathering information...
                    </div>
                </div>
                
                <!-- Queue Table -->
                <div id="queueTableContainer" class="queue-table-wrapper" style="display: none;">
                    <table class="queue-table">
                        <thead>
                            <tr>
                                <th>Job Title</th>
                                <th>Company</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="queueTableBody">
                        </tbody>
                    </table>
                </div>
                
                <!-- Empty Queue State -->
                <div class="empty-state" id="emptyQueueState">
                    <div class="empty-state-icon">üìã</div>
                    <div class="empty-state-text">No jobs in queue yet. Paste URLs above to get started.</div>
                </div>
            </div>
            
            <!-- Right Column: Results & Files -->
            <div class="card">
                <div class="card-title">Results Summary</div>
                
                <div class="results-grid">
                    <!-- Stats Cards -->
                    <div class="summary-stats">
                        <div class="stat-card">
                            <div class="stat-number success" id="statLetters">0</div>
                            <div class="stat-label">Cover Letters</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number success" id="statCards">0</div>
                            <div class="stat-label">Trello Cards</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number error" id="statErrors">0</div>
                            <div class="stat-label">Errors</div>
                        </div>
                    </div>
                    
                    <!-- Recent Files -->
                    <div class="recent-files">
                        <div class="recent-files-title">üìÇ Recent Files</div>
                        <div id="recentFilesList">
                            <div class="empty-state" style="padding: 20px 0;">
                                <div class="empty-state-text">No files generated yet</div>
                            </div>
                        </div>
                        <a href="/outputs" class="view-all-link" target="_blank">View All Outputs ‚Üí</a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Section -->
        <div class="settings-card">
            <div class="card-title">‚öôÔ∏è Settings</div>
            
            <div class="settings-grid">
                <div class="settings-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="generatePdfCheckbox" checked>
                        <label for="generatePdfCheckbox">Generate PDF</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="createTrelloCheckbox" checked>
                        <label for="createTrelloCheckbox">Create Trello Cards</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="openFilesCheckbox">
                        <label for="openFilesCheckbox">Open files after generation</label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Language</label>
                    <select id="languageSelect">
                        <option value="auto">Auto-detect</option>
                        <option value="de">Deutsch</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // State management
        let queue = [];
        let processing = false;
        let results = {
            completed: 0,
            errors: 0,
            files: []
        };
        
        // Processing steps constants
        const PROCESSING_STEPS = {
            'scraping': { label: 'Gathering information...', percent: 0 },
            'trello': { label: 'Logging in Trello...', percent: 20 },
            'cover_letter': { label: 'Generating cover letter...', percent: 60 },
            'documents': { label: 'Creating documents...', percent: 80 },
            'complete': { label: 'Complete!', percent: 100 }
        };
        
        // Current processing info
        let currentJobStep = 'scraping';
        
        // Count URLs
        document.getElementById('urlInput').addEventListener('input', function() {
            const urls = this.value.trim().split('\n').filter(url => url.trim().length > 0);
            document.getElementById('urlCount').textContent = urls.length;
        });
        
        // Paste from clipboard
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('urlInput').value = text;
                document.getElementById('urlInput').dispatchEvent(new Event('input'));
            } catch (err) {
                alert('Failed to read clipboard');
            }
        }
        
        // Clear input
        function clearInput() {
            document.getElementById('urlInput').value = '';
            document.getElementById('urlCount').textContent = '0';
            queue = [];
            updateQueueDisplay();
            document.getElementById('progressSection').style.display = 'none';
        }
        
        // Toggle pause/resume
        function togglePause() {
            const pauseBtn = document.getElementById('pauseBtn');
            if (paused) {
                paused = false;
                pauseBtn.textContent = '‚è∏ Pause';
                processNextJob();
            } else {
                paused = true;
                pauseBtn.textContent = '‚ñ∂ Resume';
            }
        }
        
        // Cancel all jobs
        async function cancelAll() {
            if (!confirm('Are you sure you want to cancel all jobs and clean up the database?')) {
                return;
            }
            
            processing = false;
            paused = false;
            queue = [];
            
            try {
                const response = await fetch('/cancel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    console.log('All jobs cancelled and database cleaned');
                }
            } catch (error) {
                console.error('Error cancelling jobs:', error);
            }
            
            // Reset UI
            document.getElementById('urlInput').value = '';
            document.getElementById('urlCount').textContent = '0';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('processAllBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('cancelAllBtn').style.display = 'none';
            document.getElementById('clearAllBtn').disabled = false;
            updateQueueDisplay();
            loadRecentFiles();
        }
        
        // Process all jobs
        function processAllJobs() {
            const urls = document.getElementById('urlInput').value.trim().split('\n').filter(url => url.trim().length > 0);
            
            if (urls.length === 0) {
                alert('Please paste job URLs first');
                return;
            }
            
            queue = urls.map((url, index) => ({
                id: `job_${Date.now()}_${index}`,
                url: url.trim(),
                status: 'queued',
                title: 'Loading...',
                company: 'Loading...',
                progress: 0
            }));
            
            processing = true;
            results.completed = 0;
            results.errors = 0;
            updateStats();
            updateQueueDisplay();
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('processAllBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').textContent = '‚è∏ Pause';
            document.getElementById('cancelAllBtn').style.display = 'inline-block';
            document.getElementById('clearAllBtn').disabled = true;
            
            processNextJob();
        }
        
        // Process next job
        async function processNextJob() {
            // Check if paused
            if (paused) {
                return;
            }
            
            const job = queue.find(j => j.status === 'queued');
            
            if (!job) {
                processing = false;
                document.getElementById('processAllBtn').style.display = 'inline-block';
                document.getElementById('pauseBtn').style.display = 'none';
                document.getElementById('cancelAllBtn').style.display = 'none';
                document.getElementById('clearAllBtn').disabled = false;
                loadRecentFiles(); // Final refresh after all jobs done
                return;
            }
            
            job.status = 'processing';
            updateQueueDisplay();
            updateProgressBar();
            
            try {
                // Get current settings
                const createTrello = document.getElementById('createTrelloCheckbox').checked;
                const generatePdf = document.getElementById('generatePdfCheckbox').checked;
                const openFiles = document.getElementById('openFilesCheckbox').checked;
                
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        url: job.url,
                        create_trello_card: createTrello,
                        generate_pdf: generatePdf,
                        open_files: openFiles
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    job.status = 'error';
                    job.error = data.error;
                    results.errors++;
                    updateStats();
                    updateQueueDisplay();
                    processNextJob();
                } else {
                    job.jobId = data.job_id;
                    // Poll immediately a few times to grab early scrape data (job title & company)
                    // before the regular 1s polling interval kicks in
                    pollForEarlyData(job);
                }
            } catch (error) {
                job.status = 'error';
                job.error = error.message;
                results.errors++;
                updateStats();
                updateQueueDisplay();
                processNextJob();
            }
        }
        
        // Poll immediately for early data (job title & company from early scrape)
        // This is aggressive polling to catch the data as soon as it's available
        async function pollForEarlyData(job) {
            let attempts = 0;
            const maxAttempts = 15; // Poll for up to ~1.5 seconds
            
            const earlyPoll = setInterval(async () => {
                attempts++;
                try {
                    const response = await fetch(`/status/${job.jobId}`);
                    const data = await response.json();
                    
                    // Check if we got the early data
                    if (data.job_title && data.job_title !== '' && job.title === 'Loading...') {
                        job.title = data.job_title;
                        job.company = data.company_name || 'Unknown';
                        console.log(`‚úì Early data grabbed at attempt ${attempts}: ${job.company} - ${job.title}`);
                        updateQueueDisplay();
                    }
                    
                    // After we have the data or max attempts, switch to normal polling
                    if ((data.job_title && data.job_title !== '') || attempts >= maxAttempts) {
                        clearInterval(earlyPoll);
                        checkJobStatus(job); // Switch to normal polling
                        return;
                    }
                } catch (error) {
                    console.error('Early poll error:', error);
                    if (attempts >= maxAttempts) {
                        clearInterval(earlyPoll);
                        checkJobStatus(job); // Fallback to normal polling
                    }
                }
            }, 100); // Poll every 100ms for the first 1.5 seconds
        }
        
        // Check job status
        async function checkJobStatus(job) {
            // Don't continue polling if paused
            if (paused) {
                return;
            }
            
            try {
                const response = await fetch(`/status/${job.jobId}`);
                
                // If job was cancelled (404), stop polling
                if (response.status === 404) {
                    console.log(`[${job.id}] Job not found (404) - stopping polling`);
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`[${job.id}] Status:`, data); // DEBUG
                
                if (data.status === 'complete') {
                    job.status = 'completed';
                    job.title = data.result.title || 'Unknown';
                    job.company = data.result.company || 'Unknown';
                    job.result = data.result;
                    job.progress = 100; // Mark as 100% complete
                    results.completed++;
                    updateStats();
                    updateQueueDisplay();
                    updateProgressBar();
                    processNextJob();
                } else if (data.status === 'error') {
                    job.status = 'error';
                    job.error = data.message;
                    results.errors++;
                    updateStats();
                    updateQueueDisplay();
                    updateProgressBar();
                    processNextJob();
                } else {
                    job.progress = data.progress || 0;
                    // Update title and company as soon as they're available (during early scrape)
                    // Only update if we currently have "Loading..." placeholder
                    if (data.job_title && job.title === 'Loading...') {
                        job.title = data.job_title;
                    }
                    if (data.company_name && job.company === 'Loading...') {
                        job.company = data.company_name;
                    }
                    updateQueueDisplay();
                    updateProgressBar();
                    setTimeout(() => {
                        if (!paused) checkJobStatus(job);
                    }, 1000);
                }
            } catch (error) {
                console.error('Error checking status:', error);
                setTimeout(() => {
                    if (!paused) checkJobStatus(job);
                }, 2000);
            }
        }
        
        // Update queue display
        function updateQueueDisplay() {
            const tbody = document.getElementById('queueTableBody');
            const emptyState = document.getElementById('emptyQueueState');
            const tableContainer = document.getElementById('queueTableContainer');
            
            tbody.innerHTML = '';
            
            if (queue.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';
            
            queue.forEach(job => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${job.title}</td>
                    <td>${job.company}</td>
                    <td>
                        <span class="status-badge ${job.status}">
                            ${job.status.charAt(0).toUpperCase() + job.status.slice(1)}
                        </span>
                    </td>
                    <td class="actions">
                        ${job.status === 'completed' ? `
                            <a href="/download/${job.result.files.docx}" class="action-link download">Word</a>
                            ${job.result.trello_card ? `<a href="${job.result.trello_card}" target="_blank" class="action-link trello">Trello</a>` : `<span class="action-link trello" style="opacity: 0.4; cursor: not-allowed; pointer-events: none;">Trello</span>`}
                        ` : job.status === 'error' ? `<span style="color: #ef4444; font-size: 0.85em;">Failed</span>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Update progress bar
        function updateProgressBar() {
            const total = queue.length;
            const completed = queue.filter(j => j.status === 'completed').length;
            const processingJob = queue.find(j => j.status === 'processing');
            
            // Show job count (e.g., "Job 1 of 3")
            const currentJobNum = completed + (processingJob ? 1 : 0);
            document.getElementById('jobsProcessing').textContent = currentJobNum;
            document.getElementById('jobsTotal').textContent = total;
            
            // Progress bar shows the CURRENT JOB'S progress (0-100%)
            const jobProgress = processingJob ? (processingJob.progress || 0) : (completed > 0 ? 100 : 0);
            document.getElementById('progressPercent').textContent = jobProgress;
            document.getElementById('progressBar').style.width = jobProgress + '%';
            
            // Update step indicator based on currently processing job
            updateProgressStepIndicator();
        }
        
        // Update progress step indicator
        function updateProgressStepIndicator() {
            const processingJob = queue.find(j => j.status === 'processing');
            
            if (!processingJob) {
                document.getElementById('progressStep').textContent = 'Ready to process...';
                currentJobStep = 'scraping';
                return;
            }
            
            // Determine step based on job progress
            let step = 'scraping';
            if (processingJob.progress >= 80) {
                step = 'documents';
            } else if (processingJob.progress >= 60) {
                step = 'cover_letter';
            } else if (processingJob.progress >= 20) {
                step = 'trello';
            } else {
                step = 'scraping';
            }
            
            currentJobStep = step;
            const stepInfo = PROCESSING_STEPS[step];
            document.getElementById('progressStep').textContent = stepInfo.label;
        }
        
        // Update stats
        function updateStats() {
            document.getElementById('statLetters').textContent = results.completed;
            document.getElementById('statCards').textContent = results.completed;
            document.getElementById('statErrors').textContent = results.errors;
        }
        
        // Allow Enter to submit in URL input
        document.getElementById('urlInput').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                processAllJobs();
            }
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadRecentFiles();
            // Refresh recent files every 5 seconds while processing
            setInterval(function() {
                if (processing) loadRecentFiles();
            }, 5000);
        });
        
        // Load recent files from API
        async function loadRecentFiles() {
            try {
                const response = await fetch('/api/recent-files?limit=10');
                const data = await response.json();
                displayRecentFiles(data.files);
            } catch (error) {
                console.error('Error loading recent files:', error);
            }
        }
        
        // Display recent files in the UI
        function displayRecentFiles(files) {
            const container = document.getElementById('recentFilesList');
            
            if (files.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 20px 0;">
                        <div class="empty-state-text">No files generated yet</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = files.map(file => {
                const date = new Date(file.time * 1000);
                const timeAgo = getTimeAgo(date);
                const fileName = file.name.length > 45 ? file.name.substring(0, 42) + '...' : file.name;
                
                return `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name" title="${file.name}">${fileName}</div>
                            <div class="file-time">${timeAgo}</div>
                        </div>
                        <a href="/download/${file.path}" class="file-download" download>‚¨á</a>
                    </div>
                `;
            }).join('');
        }
        
        // Helper: time ago formatter
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }
    </script>
</body>
</html>
